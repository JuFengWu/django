<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本益比河流圖</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .bar {
            opacity: 0.8;
            cursor: pointer;
        }

        .bar:hover {
            opacity: 1;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 5px;
            font-size: 12px;
            background: lightgray;
            border: 1px solid #ddd;
            border-radius: 4px;
            pointer-events: none;
        }

        .circle {
            fill: black;
        }
    </style>
</head>
<body>
    <h2 style="text-align: center;">本益比河流圖結果</h2>
    <div id="latest-price-container" style="text-align: center; margin-bottom: 20px;"></div>
    <div id="chart-container">
        <div id="chart1" class="chart"></div>
        <div id="chart2" class="chart"></div>
        <div id="chart3" class="chart"></div>
        <div id="chart4" class="chart"></div>
    </div>
    <div class="tooltip" style="display: none;"></div>
    <script>
        // Fetch data from the Django backend
        fetch('/api/pe-flow/')
            .then(response => response.json())
            .then(data => {
                const latestPrice = data.latest_price; // 獲取最新價格
                const charts = data.charts; // 獲取多組圖表數據

                // 渲染最新價格
                renderLatestPrice(latestPrice);

                // 渲染四組圖表
                renderChart('#chart1', charts[0].ranges, latestPrice);
                renderChart('#chart2', charts[1].ranges, latestPrice);
                renderChart('#chart3', charts[2].ranges, latestPrice);
                renderChart('#chart4', charts[3].ranges, latestPrice);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });

        /**
         * 渲染最新價格
         * @param {number} latestPrice 最新價格
         */
        function renderLatestPrice(latestPrice) {
            const container = document.getElementById('latest-price-container');
            container.innerHTML = `<h3>最新價格: ${latestPrice}</h3>`;
        }

        /**
         * 渲染圖表
         * @param {string} container 圖表容器選擇器
         * @param {Array} ranges 圖表數據範圍
         * @param {number} latestPrice 最新價格
         */
        function renderChart(container, ranges, latestPrice) {
            const width = 800;
            const height = 100;
            const margin = { top: 20, right: 20, bottom: 70, left: 50 };

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            const xScale = d3.scaleLinear()
                .domain([0, 160]) // 假設價格範圍的最大值是 160
                .range([0, width]);

            // 繪製矩形條
            svg.selectAll(".bar")
                .data(ranges)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => xScale(d.start))
                .attr("y", height / 4)
                .attr("width", d => xScale(d.end) - xScale(d.start))
                .attr("height", height / 2)
                .attr("fill", d => d.color)
                .on("mouseover", function (event, d) {
                    d3.select(".tooltip")
                        .style("display", "block")
                        .style("left", `${event.pageX + 5}px`)
                        .style("top", `${event.pageY - 28}px`)
                        .html(`${d.label}: ${d.start} - ${d.end}`);
                })
                .on("mouseout", function () {
                    d3.select(".tooltip").style("display", "none");
                });

            // 最新價格標記
            svg.append("circle")
                .attr("cx", xScale(latestPrice))
                .attr("cy", height / 2)
                .attr("r", 5)
                .attr("fill", "black");

            // 添加 x 軸
            svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(xScale).ticks(10));
        }
    </script>
</body>

</html>
