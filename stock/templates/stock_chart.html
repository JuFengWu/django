<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>選擇股票與設定</title>
    <style>
        #stock-list {
            width: 200px;
            height: 100px;
        }

        #chartA, #chartB {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        #datatable {
            margin-top: 20px;
            width: 100%;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
</head>
<body>

    <!-- 表單開始 -->
    <form id="stock-form" method="post">
        {% csrf_token %}

        <!-- 股票代碼多選框 -->
        <label for="stock-list">選擇股票代碼:</label>
        <select id="stock-list" name="selected_stocks" multiple>
            <option value="MSFT">MSFT</option>
            <option value="AAPL">AAPL</option>
            <option value="GOOG" selected>GOOG</option>
            <option value="TSLA">TSLA</option>
        </select>
        <br><br>

        <!-- 股票代碼多選框2 -->
        <label for="stock-list2">選擇股票代碼:</label>
        <select id="stock-list2" name="selected_stocks2" multiple>
            <option value="MSFT">MSFT</option>
            <option value="AAPL" selected>AAPL</option>
            <option value="GOOG">GOOG</option>
            <option value="TSLA">TSLA</option>
        </select>
        <br><br>

        <!-- 日期選擇 -->
        <label for="start_date">開始日期:</label>
        <input type="date" id="start_date" name="start_date" value="2021-01-01">

        <label for="end_date">結束日期:</label>
        <input type="date" id="end_date" name="end_date" value="2024-01-01">
        <br><br>

        <!-- window size 的滑動條與數字顯示 -->
        <label for="window_size">窗口大小:</label>
        <input type="range" id="window_size" name="window_size" min="50" max="500" value="200" oninput="document.getElementById('size_display').value = this.value">
        <input type="number" id="size_display" value="200" readonly>
        <br><br>

        <!-- 提交按鈕 -->
        <button type="button" id="submitBtn1">提交按鈕 1</button>
    </form>

    <div id="chartA"></div>
    <div id="chartB"></div>
    <table id="datatable" class="display">
        <thead>
            <tr>
                <th>Buy 1 Time</th>
                <th>Buy 2 Time</th>
                <th>Sell 1 Time</th>
                <th>Sell 2 Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        // 提交表單並生成圖表和表格
        document.getElementById('submitBtn1').addEventListener('click', function() {
            $.ajax({
                url: "{% url 'test_view' %}",
                method: "POST",
                data: $('#stock-form').serialize(),
                success: function(data) {
                    // 提取標記數據
                    const buy1Markers = data.buy1time.map((time,index) => ({
                        x: time,
                        y: data.buy1timeStock[index],
                        marker: {
                            symbol: 'triangle',
                            fillColor: 'green'
                        }
                    }));
    
                    const sell1Markers = data.sell1Time.map((time,index) => ({
                        x: Date.parse(time),
                        y: data.buy2timeStock[index],
                        marker: {
                            symbol: 'triangle',
                            fillColor: 'green'
                        }
                    }));
    
                    const buy2Markers = data.buy2time.map((time,index) => ({
                        x: Date.parse(time),
                        y: data.sell1TimeStock[index],
                        marker: {
                            symbol: 'triangle-down',
                            fillColor: 'red'
                        }
                    }));
    
                    const sell2Markers = data.sell2Time.map((time,index) => ({
                        x: Date.parse(time),
                        y: data.sell2TimeStock[index],  // 使用 sell2TimeStock 中的股價
                        marker: {
                        symbol: 'triangle-down',
                        fillColor: 'red'
                        }
                    })); 
    
                    // 1. Highcharts 圖 A (stock_data 和 stock_data2，使用日期作為 X 軸)
                    Highcharts.chart('chartA', {
                        title: {
                            text: 'Stock Data Chart'
                        },
                        xAxis: {
                            type: 'datetime',
                            dateTimeLabelFormats: {
                                month: '%b %e, %Y',
                                year: '%Y'
                            },
                            title: {
                                text: 'Date'
                            }
                        },
                        series: [
                            {
                                name: 'Stock Data',
                                data: data.stock_data,
                            },
                            {
                                name: 'Stock Data 2',
                                data: data.stock_data2,
                            },
                            // 標記 buy1time 和 sell1Time 的綠色向上三角形
                            {
                                name: 'Buy/Sell Markers',
                                type: 'scatter',
                                data: buy1Markers.concat(sell1Markers),
                                marker: {
                                    radius: 8
                                }
                            },
                            // 標記 buy2time 和 sell2Time 的紅色向下三角形
                            {
                                name: 'Sell Markers',
                                type: 'scatter',
                                data: buy2Markers.concat(sell2Markers),
                                marker: {
                                    radius: 8
                                }
                            }
                        ]
                    });
    
                    // 2. Highcharts 圖 B (spread、upperline、downline 和 averageLine)
                    Highcharts.chart('chartB', {
                        title: {
                            text: 'Spread and Lines'
                        },
                        xAxis: {
                            type: 'datetime',
                            dateTimeLabelFormats: {
                                month: '%b %e, %Y',
                                year: '%Y'
                            },
                            title: {
                                text: 'Date'
                            }
                        },
                        series: [
                            {
                                name: 'Spread',
                                data: data.spread
                            },
                            {
                                name: 'Upper Line',
                                data: data.upperline.map(([timestamp, value]) => [Date.parse(timestamp), value])
                            },
                            {
                                name: 'Down Line',
                                data: data.downline.map(([timestamp, value]) => [Date.parse(timestamp), value])
                            },
                            {
                                name: 'Average Line',
                                data: data.averageLine.map(([timestamp, value]) => [Date.parse(timestamp), value])
                            }
                        ]
                    });
    
                    // 3. DataTables (buy1time、buy2time、sell1Time、sell2Time)
                    $('#datatable').DataTable({
                        data: [
                            [data.buy1time, data.buy2time, data.sell1Time, data.sell2Time]
                        ],
                    });
                },
                error: function(error) {
                    console.error("Error:", error);
                }
            });
        });
    
        // 確保當數字顯示框中的值變更時，滑動條同步更新
        document.getElementById('size_display').oninput = function() {
            document.getElementById('window_size').value = this.value;
        };
    </script>

</body>
</html>
